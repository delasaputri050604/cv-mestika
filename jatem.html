<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1200">

<title>Jatuh Tempo â€” CV Mestika Lestari</title>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{
  box-sizing:border-box;
  font-family:Arial, sans-serif;
}

body{
  margin:0;
  background:#f4f6f8;
}

/* HEADER */
header{
  background:#1b5e20;
  color:#fff;
  padding:20px;
  text-align:center;
  font-size:24px;
  font-weight:bold;
}

/* CONTAINER */
.container{
  width:1200px;
  margin:20px auto;
}

/* SEARCH */
.search-box{
  background:#fff;
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
}

.search-box input{
  width:100%;
  padding:10px;
  font-size:14px;
}

/* ACTION */
.action{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-bottom:10px;
}

button{
  padding:8px 16px;
  border:none;
  border-radius:6px;
  background:#1b5e20;
  color:#fff;
  cursor:pointer;
}

/* TABLE */
.table-wrap{
  background:#fff;
  border-radius:8px;
  overflow-x:auto;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  border:1px solid #ccc;
  padding:10px;
}

th{
  background:#c8e6c9;
  text-align:center;
}

tbody tr:nth-child(even){
  background:#f1f8e9;
}

tbody tr:hover{
  background:#e8f5e9;
}

/* STATUS */
.status{
  padding:4px 12px;
  border-radius:20px;
  font-size:12px;
  font-weight:bold;
  color:#fff;
  text-align:center;
}

.lunas{background:#16a34a}
.terlambat{background:#dc2626}
.warning{background:#facc15;color:#000}
.aktif{background:#2563eb}

/* PRINT LANDSCAPE */
@media print{
  @page{
    size:A4 landscape;
    margin:15mm;
  }

  header,
  .search-box,
  .action{
    display:none !important;
  }

  body{
    background:#fff;
  }

  .container{
    width:100%;
  }

  table{
    font-size:12px;
  }

  th,td{
    border:1px solid #000;
  }
}
</style>
</head>

<body>

<header>JATUH TEMPO â€” CV MESTIKA LESTARI</header>

<div class="container">

  <div class="search-box">
    <input id="searchInput" placeholder="Cari invoice, customer, keterangan..." onkeyup="filterData()">
  </div>

  <div class="action">
    <button onclick="window.print()">ðŸ–¨ Print</button>
    <button onclick="exportPDF()">ðŸ“„ PDF</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzs6QQMeRvDu5-vZXsPnXdgODY-IKdGmYhCYP8VVc22cd-YHO2ktfznT2G3CQLxOiAG/exec";
let dataJT=[];

/* ===== HELPER ===== */
function rupiah(v){
  if(!v) return "";
  return "Rp " + Number(v).toLocaleString("id-ID");
}

function tanggal(v){
  if(!v) return "";
  return v.toString().substring(0,10);
}

function statusJT(jt,ket){
  if(ket && ket.toLowerCase().includes("lunas"))
    return {t:"LUNAS",c:"lunas"};

  const today=new Date(); today.setHours(0,0,0,0);
  const d=new Date(jt); d.setHours(0,0,0,0);
  const diff=Math.ceil((d-today)/86400000);

  if(diff<0) return {t:"TERLAMBAT",c:"terlambat"};
  if(diff<=3) return {t:"JATUH TEMPO",c:"warning"};
  return {t:"AKTIF",c:"aktif"};
}

/* ===== LOAD ===== */
async function loadData(){
  const res=await fetch(API_URL);
  dataJT=await res.json();
  render(dataJT);
}

/* ===== RENDER ===== */
function render(data){
  if(!data.length) return;

  const headers=Object.keys(data[0]);
  thead.innerHTML="<tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"<th>STATUS</th></tr>";

  let html="";
  data.forEach(r=>{
    const st=statusJT(r["JATUH TEMPO"],r["KETERANGAN"]);
    html+="<tr>";
    headers.forEach(h=>{
      if(h.includes("TANGGAL") || h.includes("JATUH"))
        html+=`<td>${tanggal(r[h])}</td>`;
      else if(h.includes("TOTAL"))
        html+=`<td align="right">${rupiah(r[h])}</td>`;
      else
        html+=`<td>${r[h] ?? ""}</td>`;
    });
    html+=`<td><span class="status ${st.c}">${st.t}</span></td></tr>`;
  });

  tbody.innerHTML=html;
}

/* ===== SEARCH ===== */
function filterData(){
  const k=searchInput.value.toLowerCase();
  render(dataJT.filter(r=>Object.values(r).join(" ").toLowerCase().includes(k)));
}

/* ===== PDF LANDSCAPE ===== */
async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const canvas=await html2canvas(document.body,{scale:2});
  const img=canvas.toDataURL("image/png");

  const pdf=new jsPDF("landscape","mm","a4");
  const w=pdf.internal.pageSize.getWidth();
  const h=canvas.height*w/canvas.width;

  pdf.addImage(img,"PNG",0,10,w,h);
  pdf.save("Jatuh_Tempo_CV_Mestika_Lestari.pdf");
}

loadData();
</script>

</body>
</html>
